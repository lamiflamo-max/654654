$vhdxPath = "$env:USERPROFILE\Desktop\Saved.vhdx"

# 1. Generate Random Password
$passwordCharSet = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"
$password = -join ((1..32) | ForEach-Object { $passwordCharSet[(Get-Random -Maximum $passwordCharSet.Length)] })
$securePassword = ConvertTo-SecureString $password -AsPlainText -Force

# 2. Use DiskPart to Mount and Format
# Creating a temporary instruction file for DiskPart
$dpScript = @"
select vdisk file="$vhdxPath"
attach vdisk
clean
convert gpt
create partition primary
format fs=ntfs quick label="SecureTest"
assign
"@
$dpScript | Out-File "$env:TEMP\dp.txt" -Encoding ASCII
diskpart /s "$env:TEMP\dp.txt"

# 3. Get the Drive Letter of the newly mounted VHD
# We look for the volume labeled "SecureTest"
$driveLetter = (Get-Volume -FileSystemLabel "SecureTest").DriveLetter + ":"

# 4. Encrypt with BitLocker
if ($driveLetter) {
    Enable-BitLocker -MountPoint $driveLetter -PasswordProtector -Password $securePassword -UsedSpaceOnly
    Write-Host "`nSUCCESS!" -ForegroundColor Cyan
    Write-Host "Password: $password" -ForegroundColor Green
} else {
    Write-Host "Could not find the mounted volume." -ForegroundColor Red
}
